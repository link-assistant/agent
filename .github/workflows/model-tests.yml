name: Model Tests

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'Model (from dropdown)'
        required: true
        type: choice
        default: 'groq/llama-3.3-70b-versatile'
        options:
          # Groq models (sorted alphabetically)
          - groq/deepseek-r1-distill-llama-70b
          - groq/gemma2-9b-it
          - groq/llama-3.1-8b-instant
          - groq/llama-3.3-70b-versatile
          - groq/llama-guard-3-8b
          - groq/llama3-70b-8192
          - groq/llama3-8b-8192
          - groq/meta-llama/llama-4-maverick-17b-128e-instruct
          - groq/meta-llama/llama-4-scout-17b-16e-instruct
          - groq/meta-llama/llama-guard-4-12b
          - groq/mistral-saba-24b
          - groq/moonshotai/kimi-k2-instruct
          - groq/moonshotai/kimi-k2-instruct-0905
          - groq/openai/gpt-oss-120b
          - groq/openai/gpt-oss-20b
          - groq/qwen-qwq-32b
          - groq/qwen/qwen3-32b
          # OpenCode models (sorted alphabetically)
          - opencode/alpha-doubao-seed-code
          - opencode/alpha-gd4
          - opencode/alpha-minimax-m2
          - opencode/big-pickle
          - opencode/claude-3-5-haiku
          - opencode/claude-haiku-4-5
          - opencode/claude-opus-4-1
          - opencode/claude-opus-4-5
          - opencode/claude-sonnet-4
          - opencode/claude-sonnet-4-5
          - opencode/gemini-3-pro
          - opencode/glm-4.6
          - opencode/gpt-5
          - opencode/gpt-5-codex
          - opencode/gpt-5-nano
          - opencode/gpt-5.1
          - opencode/gpt-5.1-codex
          - opencode/gpt-5.1-codex-max
          - opencode/grok-code
          - opencode/kimi-k2
          - opencode/kimi-k2-thinking
          - opencode/qwen3-coder
      custom_model:
        description: 'Custom model name in provider/model format (overrides dropdown if set)'
        required: false
        type: string
        default: ''
      test_type:
        description: 'Test Type'
        required: true
        type: choice
        default: 'both'
        options:
          - with_tools
          - without_tools
          - both

jobs:
  test-model:
    runs-on: ubuntu-latest
    env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install
        working-directory: js

      - name: Determine model to test
        id: model
        run: |
          CUSTOM_MODEL="${{ inputs.custom_model }}"
          MODEL_FROM_DROPDOWN="${{ inputs.model }}"

          if [ -n "$CUSTOM_MODEL" ]; then
            MODEL_ID="$CUSTOM_MODEL"
          else
            MODEL_ID="$MODEL_FROM_DROPDOWN"
          fi

          # Extract provider and model name from provider/model format
          PROVIDER=$(echo "$MODEL_ID" | cut -d'/' -f1)
          MODEL_NAME=$(echo "$MODEL_ID" | cut -d'/' -f2-)

          echo "model_id=$MODEL_ID" >> $GITHUB_OUTPUT
          echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "provider=$PROVIDER" >> $GITHUB_OUTPUT
          echo "Testing model: $MODEL_ID (provider: $PROVIDER, model: $MODEL_NAME)"

      - name: Fetch model capabilities
        id: capabilities
        run: |
          OUTPUT=$(node scripts/get-model-info.mjs "${{ steps.model.outputs.provider }}" "${{ steps.model.outputs.model_name }}")
          echo "$OUTPUT"
          echo "$OUTPUT" >> $GITHUB_OUTPUT

      - name: Check API key availability
        run: |
          if [ "${{ steps.model.outputs.provider }}" = "groq" ]; then
            if [ -z "$GROQ_API_KEY" ]; then
              echo "::warning::GROQ_API_KEY is not set. Groq tests may fail."
            else
              echo "GROQ_API_KEY is configured"
            fi
          fi

      - name: Test without tools (simple response)
        if: inputs.test_type == 'without_tools' || inputs.test_type == 'both'
        run: node scripts/test-model-simple.mjs "${{ steps.model.outputs.model_id }}"

      - name: Test with tools (tool calling)
        if: inputs.test_type == 'with_tools' || inputs.test_type == 'both'
        run: node scripts/test-model-tools.mjs "${{ steps.model.outputs.model_id }}"

      - name: Summary
        run: |
          echo "## Model Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: ${{ steps.model.outputs.model_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Provider**: ${{ steps.model.outputs.provider }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Type**: ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output-simple.log ]; then
            echo "### Simple Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 test-output-simple.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f test-output-tools.log ]; then
            echo "### Tool Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 test-output-tools.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
