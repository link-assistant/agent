# Case Study: Issue #142 - Automatic Retry on Timeout Errors

## Problem Statement

The agent fails immediately when an API request times out with `"The operation timed out."` instead of retrying the operation. This causes entire work sessions to lose progress on transient network issues.

## Timeline of Events

1. **2026-01-30T14:55:24Z** - Agent successfully completes a step (step_finish event with tokens and cost data)
2. **2026-01-30T14:55:27Z** - Agent starts a new step (step_start event)
3. **2026-01-30T14:56:20Z** - ~53 seconds later, an error occurs: `"The operation timed out."`
4. **2026-01-30T14:57:32Z** - Agent recovers but work is disrupted

The timeout occurred between `step_start` and the expected API response, indicating the AI provider API request timed out.

## Root Cause Analysis

### Error Origin

The error `"The operation timed out."` is a `DOMException` with `name === 'TimeoutError'`, generated by `AbortSignal.timeout()` in Bun's runtime. This signal is set up in the provider configuration:

```typescript
// js/src/provider/provider.ts:865-866
if (options['timeout'] !== false)
  signals.push(AbortSignal.timeout(options['timeout']));
```

### Error Propagation Path

1. `AbortSignal.timeout()` fires after the configured timeout period
2. The `fetch()` call is aborted with a `DOMException { name: 'TimeoutError', message: 'The operation timed out.' }`
3. The AI SDK's `handleFetchError()` calls `isAbortError()` which returns `true` for `TimeoutError`
4. The error is **re-thrown as-is** (NOT wrapped in `APICallError`)
5. In `SessionProcessor.process()`, the error is caught and passed to `MessageV2.fromError()`
6. `fromError()` checks `e instanceof DOMException && e.name === 'AbortError'` - this does NOT match `TimeoutError`
7. The error falls through to the generic `Error` handler, creating a `NamedError.Unknown`
8. `NamedError.Unknown` is NOT retryable, so the session stops

### AI SDK's isAbortError Function

The AI SDK (version 6.0.0-beta.99) treats `TimeoutError` the same as `AbortError`:

```javascript
// @ai-sdk/provider-utils/dist/index.mjs:135-138
function isAbortError(error) {
  return (error instanceof Error || error instanceof DOMException) &&
    (error.name === "AbortError" || error.name === "ResponseAborted" || error.name === "TimeoutError");
}
```

This means timeout errors bypass `APICallError` wrapping entirely.

### Missing Retry Logic

The existing retry logic in `processor.ts` only handles:
- `APIError` with `isRetryable: true` (HTTP 408, 409, 429, 500+)
- `SocketConnectionError` (Bun's 10-second idle timeout)

It does NOT handle `DOMException` with `name === 'TimeoutError'`.

## Retryable HTTP Status Codes

The AI SDK considers these HTTP status codes retryable (via `APICallError`):
- **408** - Request Timeout
- **409** - Conflict
- **429** - Too Many Requests
- **500+** - All Server Errors (500, 502, 503, 504, etc.)

These are already handled by the existing retry logic when the error is an `APICallError` with `isRetryable: true`.

## Solution

### Approach

Add a new `TimeoutError` error type alongside the existing `SocketConnectionError`, with its own retry configuration using the requested intervals (30s, 60s, 120s). Detect `DOMException` with `name === 'TimeoutError'` in `fromError()` and create a retryable error.

### Changes Required

1. **`js/src/session/message-v2.ts`**: Add `TimeoutError` type and detect timeout errors in `fromError()`
2. **`js/src/session/retry.ts`**: Add timeout-specific retry configuration (3 retries, 30s/60s/120s intervals)
3. **`js/src/session/processor.ts`**: Add retry handling for `TimeoutError`
4. **Tests**: Add test coverage for timeout retry behavior

### Retry Intervals

As requested in the issue:
- Attempt 1: 30 seconds delay
- Attempt 2: 60 seconds delay
- Attempt 3: 120 seconds delay

## Data Files

- `solution-draft-log-pr-1769785056376.txt` - Full execution log showing the timeout error

## Related Issues

- Bun's 10-second idle timeout: https://github.com/oven-sh/bun/issues/14439
- Referenced PR example: https://github.com/netkeep80/isocubic/pull/129#issuecomment-3824186453
